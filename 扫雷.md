import tkinter as tk
import random
from tkinter import messagebox

class Minesweeper:
    def __init__(self, root, rows, cols, mines):
        self.root = root
        self.rows = rows
        self.cols = cols
        self.mines = mines
        self.board = [[' ' for _ in range(cols)] for _ in range(rows)]
        self.buttons = [[None for _ in range(cols)] for _ in range(rows)]
        self.mine_coords = []
        self.flagged = []
        self.revealed = []
        self.first_click = True
        self.game_over = False

        self.create_mines()
        self.create_gui()

    def create_mines(self):
        self.mine_coords = random.sample(
            [(i, j) for i in range(self.rows) for j in range(self.cols)], self.mines)
        for row, col in self.mine_coords:
            self.board[row][col] = 'X'

    def create_gui(self):
        for row in range(self.rows):
            for col in range(self.cols):
                # 增加按钮的宽度和高度，以更好地展示中文字符
                button = tk.Button(self.root, text=' ', width=6, height=2, bg='light gray', fg='black')
                button.grid(row=row, column=col)
                button.bind('<Button-1>', lambda event, r=row, c=col: self.left_click(r, c))
                button.bind('<Button-3>', lambda event, r=row, c=col: self.right_click(r, c))
                self.buttons[row][col] = button

    def left_click(self, row, col):
        if self.game_over or (row, col) in self.revealed:
            return

        if self.first_click:
            while (row, col) in self.mine_coords:
                self.create_mines()
            self.first_click = False

        if (row, col) in self.mine_coords:
            self.explode_mines()
        else:
            count = self.count_adjacent_mines(row, col)
            name_mapping = {1: "冯仲科", 2: "曹云锋", 3: "黄季夏", 4: "闫飞", 5: "杨波"}
            display_text = name_mapping.get(count, str(count))
            if count > 0:
                self.buttons[row][col].config(text=display_text, state=tk.DISABLED, bg='white')
            else:
                self.reveal_empty_cells(row, col)
        self.revealed.append((row, col))
        if self.check_win():
            self.game_win()

    def right_click(self, row, col):
        if self.game_over or (row, col) in self.revealed:
            return

        if (row, col) not in self.flagged:
            self.flagged.append((row, col))
            self.buttons[row][col].config(text='于强', state=tk.DISABLED, bg='yellow')
        else:
            self.flagged.remove((row, col))
            self.buttons[row][col].config(text=' ', state=tk.NORMAL, bg='light gray')

    def count_adjacent_mines(self, row, col):
        count = 0
        for i in range(-1, 2):
            for j in range(-1, 2):
                if 0 <= row + i < self.rows and 0 <= col + j < self.cols and self.board[row + i][col + j] == 'X':
                    count += 1
        return count

    def reveal_empty_cells(self, row, col):
        self.buttons[row][col].config(state=tk.DISABLED, bg='white')
        self.board[row][col] = '0'
        for i in range(-1, 2):
            for j in range(-1, 2):
                if 0 <= row + i < self.rows and 0 <= col + j < self.cols:
                    if (row + i, col + j) not in self.revealed:
                        self.left_click(row + i, col + j)

    def check_win(self):
        return all(self.board[row][col] != 'X' and (row, col) in self.revealed for row in range(self.rows) for col in range(self.cols))

    def explode_mines(self):
        for row, col in self.mine_coords:
            self.buttons[row][col].config(text='卢昊', state=tk.DISABLED, bg='red')
        self.game_over = True
        result = messagebox.askquestion("结果", "你输了！再来一把？")
        if result == "yes":
            self.reset_game()
        else:
            self.root.quit()

    def game_win(self):
        for row in range(self.rows):
            for col in range(self.cols):
                if (row, col) in self.mine_coords:
                    self.buttons[row][col].config(text='X', state=tk.DISABLED, bg='green')
        self.game_over = True
        result = messagebox.askquestion("结果", "你赢了！再来一把？")
        if result == "yes":
            self.reset_game()
        else:
            self.root.quit()

    def reset_game(self):
        self.mine_coords = []
        self.flagged = []
        self.revealed = []
        self.first_click = True
        self.game_over = False
        for row in range(self.rows):
            for col in range(self.cols):
                self.buttons[row][col].config(text=' ', state=tk.NORMAL, bg='light gray')
                self.board[row][col] = ' '
        self.create_mines()
        self.create_gui()

if __name__ == "__main__":
    rows = 10
    cols = 15
    mines = 15

    root = tk.Tk()
    root.title("Minesweeper")
    game = Minesweeper(root, rows, cols, mines)
    root.mainloop()
